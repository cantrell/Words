<!DOCTYPE html>

<html>
    <head>

        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

        <title>Words</title>

        <link href="wikipedia.css" rel="stylesheet" type="text/css" />
        <link href="dictionary.css" rel="stylesheet" type="text/css" />

        <style>

            html {
                height: 100%;
                overflow-y: scroll;
                overflow-x: hidden;
            }

            body {
                font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
                font-weight: 300;
                font-size: 15px;
                color: #666;
                background: -webkit-radial-gradient(center, rgb(255, 255, 255) 400px,rgb(153, 153, 153) 1200px);
                background-attachment: fixed;
            }

            a {text-decoration: none; color: #03f}
            a:active {color: #6cf}

            #helpLabel {
                position: absolute;
                left: 4px;
                top: 0px;
            }

            #helpBox {
                position: absolute;
                left: -285px;
                top: 25px;
            }

            #historyLabel {
                position: absolute;
                right: 4px;
                top: 0px;
            }

            #historyBox {
                position: absolute;
                right: -125px;
                top: 25px;
            }

            .hiddenBox {
                background-color: #fff;
                border-radius: 8px;
                -webkit-box-shadow: 2px 2px 25px #000;
                overflow: hidden;
                padding:  5px;
            }

            #mainContainer {
                width: 80%;
                margin-top: 100px;
                margin-left: auto;
                margin-right: auto;
            }

            #inputContainer {
                text-align: center;
                margin-bottom: 5px;
            }

            #wordInput {
                border: 1px solid #ccc;
                border-radius: 10px;
                text-align: center;
                color: #666;
                /*visibility: hidden;*/
            }

            #wordInput:focus { outline: none }

            #ruler {
                visibility: hidden;
                position: absolute;
            }

            .inputText {
                font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
                font-weight: 300;
                font-size: 15px;
            }

            #spinner {
                margin: 0 auto;
                opacity: 0;
            }
            
            #operationContainer {
                text-align: center;
                opacity: 0;
                margin-bottom: 15px;
            }

            .operationLink:focus {
                outline: 1px solid #ccc;
            }

            #dataContainer {
                padding-top: 15px;
                opacity: 1;
            }

            #info {
                opacity: 0;
            }

            .fadable {-webkit-transition: opacity .5s ease-in}
            
            .tweenable {
                -webkit-transition-property: left, right;
                -webkit-transition-duration: .25s;
                -webkit-transition-timing-function: ease-in;
            }
        </style>

        <script type="text/javascript">

            var minWordInputWidth;
            var intervals = {
                scroll: -1
            };

            function init() {
                window.addEventListener('keydown', onKeyDown);
                id('wordInput').addEventListener('keyup', onWordInputChange);
                id('dataContainer').addEventListener('dblclick', onDoubleClick);
                minWordInputWidth = id('ruler').clientWidth + 4;
                id('wordInput').style.width = minWordInputWidth + 'px';
                id('wordInput').placeholder = id('ruler').innerHTML;
                id('wordInput').style.visibility = 'visible';

                // Set up the spinner
                var spinner = getSpinner('20px', 12, '#000');
                spinner.setAttribute('id', 'spinner');
                spinner.setAttribute('class', 'fadable');
                id('spinnerContainer').appendChild(spinner);
            }

            function onDoubleClick(event) {
                var selectedText = getSelectedText();
                if (!exists(selectedText)) return;
                id('wordInput').value = selectedText;
                onWordInputChange();
            }

            function onKeyDown(event) {
                if (event.keyCode == 27) {
                    console.log("WHY AM I BEING CALLED SO MUCH?"); // TBD
                    id('wordInput').value = '';
                    onWordInputChange();
                    id('dataContainer').style.opacity = 0;
                    hideHelp();
                    hideHistory();
                }
            }

            function onWordInputChange(e) {
                var inputVal = id('wordInput').value;
                id('ruler').innerHTML = inputVal;
                wordInputWidth = id('ruler').clientWidth + 12;
                if (wordInputWidth > minWordInputWidth) {
                    id('wordInput').style.width = wordInputWidth + 'px';
                } else {
                    id('wordInput').style.width = minWordInputWidth + 'px';
                }
                id('operationContainer').style.opacity = (inputVal.length == 0) ? 0 : 1;
            }

            function startLookup(searchFunction, arg1, arg2, arg3) {
                if (id('wordInput').value == '') return;
                id('spinner').style.opacity = 1;
                var callback = function() {
                    id('dataContainer').removeEventListener('webkitTransitionEnd', callback);
                    searchFunction.apply(window, [arg1, arg2, arg3]);
                };
                id('dataContainer').addEventListener('webkitTransitionEnd', callback);
                scrollUp();
                setTimeout(function(){id('dataContainer').style.opacity = 0}, 1)
            }

            function finishLookup() {
                id('spinner').style.opacity = 0;
                setTimeout(function(){id('dataContainer').style.opacity = 1}, 1);
            }

            function scrollUp() { intervals.scroll = setInterval(_scroll, 10); }

            function _scroll() {
                window.scrollBy(0, -(window.scrollY / 5));
                if (window.scrollY <= 5) {
                    clearInterval(intervals.scroll);
                    window.scrollTo(0, 0);
                }
            }

            // Wikipedia

            function doResearch(topic) {
                var title;
                if (exists(topic)) {
                    title = topic;
                    id('wordInput').value = topic.replace(/_/g, ' ');
                    onWordInputChange();
                } else {
                    title = id('wordInput').value;
                }
                title = title.replace(/ /g, '_');
                wikipediaRequest('http://en.wikipedia.org/w/index.php?action=render&title=' + encodeURIComponent(title));
            }

            function wikipediaRequest(url) {
                var fullUrl = 'http://www.christiancantrell.com/words/wikipedia.php?url=' + encodeURIComponent(url);
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function ()
                {
                    if (this.readyState == 4 && this.status == 200) {
                        id('dataContainer').innerHTML = this.responseText;
                        var anchors = id('dataContainer').getElementsByTagName('a');
                        for (var i = 0; i < anchors.length; ++i) {
                            var href = anchors[i].getAttribute('href');
                            if (href.match(/^\/\/en\.wikipedia\.org\/wiki\//)) {
                                anchors[i].setAttribute('href', 'javascript:startLookup(doResearch, "' + href.substring(href.lastIndexOf('/') + 1, href.length) + '");');
                            } else {
                                anchors[i].setAttribute('target', '_new');
                            }
                        }
                        finishLookup();
                    }
                };
                xhr.open('GET', fullUrl);
                xhr.send();
            }

            // Dictionary

            function doDictionary(site, word) {
                var q = (word != null) ? word: id('wordInput').value;
                if (site == 'dictionary') {
                    dictionaryRequest('http://api-pub.dictionary.com/v001?type=define&site='+site+'&q='+q);
                } else if (site == 'thesaurus') {
                    thesaurusRequest('http://api-pub.dictionary.com/v001?type=define&site='+site+'&q='+q);
                }
            }

            function thesaurusRequest(url) {
                var fullUrl = 'http://www.christiancantrell.com/words/dictionary.php?url=' + encodeURIComponent(url);
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function ()
                {
                    if (this.readyState == 4 && this.status == 200) {

                        removeAllChildren(id('dataContainer'));
                        var outputDiv = document.createElement('div');
                        var response = this.responseXML;
                        var entries = response.getElementsByTagName('entry');

                        if (entries.length == 0) {
                            outputDiv.innerHTML = 'No synonyms found.';
                        }

                        for (var i = 0; i < entries.length; ++i) {
                            var entry = entries[i];
                            var entryDiv = document.createElement('div');
                            outputDiv.appendChild(entryDiv);

                            var headwordSpan = document.createElement('span');
                            headwordSpan.setAttribute('class', 'dictionaryHeadword');
                            entryDiv.appendChild(headwordSpan);
                            headwordSpan.innerHTML = entry.getElementsByTagName('headword')[0].childNodes[0].nodeValue;

                            var posSpan = document.createElement('span');
                            posSpan.setAttribute('class', 'dictionaryPos');
                            entryDiv.appendChild(posSpan);
                            posSpan.innerHTML = '&nbsp;' + entry.getElementsByTagName('partofspeech')[0].childNodes[0].nodeValue;

                            var defSpan = document.createElement('span');
                            entryDiv.appendChild(defSpan);
                            defSpan.innerHTML = '&nbsp;' + entry.getElementsByTagName('definition')[0].childNodes[0].nodeValue;

                            var synonymsDiv = document.createElement('div');
                            entryDiv.appendChild(synonymsDiv);
                            var synonymsBq = document.createElement('blockquote');
                            synonymsDiv.appendChild(synonymsBq);
                            var synonymsText = entry.getElementsByTagName('synonyms')[0].childNodes[0].nodeValue;
                            synonymsText = synonymsText.replace(/<a.*?>(.+?)<\/a>/img, '$1');
                            synonymsBq.innerHTML = synonymsText;
                        }

                        id('dataContainer').appendChild(outputDiv);
                        finishLookup();
                    }
                };
                xhr.open('GET', fullUrl);
                xhr.send();
            }

            function dictionaryRequest(url) {
                var fullUrl = 'http://www.christiancantrell.com/words/dictionary.php?url=' + encodeURIComponent(url);
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function ()
                {
                    if (this.readyState == 4 && this.status == 200) {
                        removeAllChildren(id('dataContainer'));
                        var outputDiv = document.createElement('div');
                        var response = this.responseXML;
                        var entries = response.getElementsByTagName('entry');

                        if (entries.length == 0) {
                            outputDiv.innerHTML = 'No definitions found.';
                        }

                        for (var i = 0; i < entries.length; ++i) {
                            var entry = entries[i];
                            var displayFormDiv = document.createElement('div');
                            var displayFormSpan = document.createElement('span');
                            displayFormDiv.appendChild(displayFormSpan);
                            displayFormSpan.setAttribute('class', 'dictionaryHeadword');
                            displayFormSpan.innerHTML = entry.getElementsByTagName('display_form')[0].childNodes[0].nodeValue;

                            // Are we an idiom?
                            var idiomTest = (entry.getElementsByTagName('partofspeech')[0].getAttribute('pos') == 'idiom') ? true : false;
                            if (idiomTest) {
                                var idiomSpan = document.createElement('span');
                                displayFormSpan.appendChild(idiomSpan);
                                idiomSpan.setAttribute('class', 'dictionaryPos');
                                var labelTest = entry.getElementsByTagName('partofspeech')[0].getAttribute('label');
                                idiomSpan.innerHTML = (exists(labelTest) && labelTest == "Informal") ? '&nbsp;(idiom,&nbsp;informal)' : '&nbsp;(idiom)' ;
                            }

                            var pron = entry.getElementsByTagName('pron')[0];
                            if (pron != undefined) {
                                var pronSpan = document.createElement('span');
                                pronSpan.setAttribute('class', 'dictionaryPron');
                                pronSpan.innerHTML = '&nbsp;' + pron.childNodes[0].nodeValue;
                                displayFormDiv.appendChild(pronSpan);
                            }

                            // parts of speech
                            var partsOfSpeech = entry.getElementsByTagName('partofspeech');

                            var posOl = document.createElement('ol');
                            if (partsOfSpeech.length > 0 && !idiomTest) {
                                displayFormDiv.appendChild(posOl);
                            }

                            for (var j = 0; j < partsOfSpeech.length; ++j) {
                                var pos = partsOfSpeech[j];
                                var posLi = document.createElement('li');
                                posLi.innerHTML = pos.getAttribute('pos');
                                posOl.appendChild(posLi);

                                var defSet = pos.getElementsByTagName('defset')[0];

                                if (defSet != undefined) {
                                    var defUl = document.createElement('ul');
                                    if (idiomTest) {
                                        displayFormDiv.appendChild(defUl);
                                    } else {
                                        posLi.appendChild(defUl);
                                    }
                                    var defs = defSet.getElementsByTagName('def');
                                    for (var k = 0; k < defs.length; ++k) {
                                        var def = defs[k];
                                        var defLi = document.createElement('li');
                                        defUl.appendChild(defLi);
                                        defLi.innerHTML = def.childNodes[0].nodeValue;
                                    }
                                }
                            }

                            // derivatives
                            var derivatives = entry.getElementsByTagName('derivatives');
                            var derOl = document.createElement('ol');
                            if (derivatives.length > 0) {
                                var derP = document.createElement('p');
                                displayFormDiv.appendChild(derP);
                                derP.setAttribute('class', 'dictionaryDerivativesLabel');
                                derP.innerHTML = 'derivatives';
                                displayFormDiv.appendChild(derOl);
                            }

                            for (var j = 0; j < derivatives.length; ++j) {
                                var derivative = derivatives[j];
                                var derLi = document.createElement('li');
                                derLi.innerHTML = derivative.getAttribute('pos');
                                derOl.appendChild(derLi);

                                var frms = derivative.getElementsByTagName('frm');

                                if (frms.length > 0) {
                                    var frmUl = document.createElement('ul');
                                    derLi.appendChild(frmUl);
                                    for (var k = 0; k < frms.length; ++k) {
                                        var frm = frms[k];
                                        var headword = frm.getElementsByTagName('headword')[0].childNodes[0].nodeValue;
                                        var phon = frm.getElementsByTagName('phon')[0].childNodes[0].nodeValue;
                                        var frmLi = document.createElement('li');
                                        frmUl.appendChild(frmLi);
                                        frmLi.innerHTML = headword + '  (' + phon + ')';
                                    }
                                }
                            }
                            outputDiv.appendChild(displayFormDiv);
                        }
                        id('dataContainer').appendChild(outputDiv);
                        finishLookup();
                    }
                };
                xhr.open('GET', fullUrl);
                xhr.send();
            }

            function showHelp() {id('helpBox').style.left = '5px'};
            function hideHelp() {id('helpBox').style.left=((parseInt(id('helpBox').style.width)+25)*-1)+'px'}
            function showHistory() {id('historyBox').style.right = '5px'}
            function hideHistory() {id('historyBox').style.right='-125px'}

            window.onload = init;

        </script>
    </head>

    <body>
        <div id="helpLabel"><a href="javascript:showHelp()">help</a></div>
        <div id="helpBox" class="hiddenBox tweenable" style="width: 260px; height: 80px;">
            <ol>
                <li>double-click words to search</li>
                <li>press esc to clear your search</li>
            </ol>
            <div style="text-align: right"><a href="javascript:hideHelp()">close</a></div>
        </div>
        <div id="historyLabel"><a href="javascript:showHistory()">history</a></div>
        <div id="historyBox" class="hiddenBox tweenable" style="width: 100px; height: 300px;">
            <ulHistory
            <div style="text-align: left"><a href="javascript:hideHistory()">close</a></div>
        </div>
        <div id="mainContainer">
            <div id="inputContainer">
                <input id="wordInput" type="text" class="inputText" tabindex="1" autofocus/> <!-- autofocus -->
            </div>
            <div id="spinnerContainer"></div>
            <div id="operationContainer" class="fadable">
                <a href="javascript:startLookup(doDictionary, 'dictionary');" class="operationLink" tabindex="2">meaning</a> &#8756;
                <a href="javascript:startLookup(doDictionary, 'thesaurus');" class="operationLink" tabindex="3">synonyms</a> &#8756;
                <!--<a href="#" class="operationLink" tabindex="4">examples</a> &#8756;-->
                <a href="javascript:startLookup(doResearch);" class="operationLink" tabindex="5">research</a>
                <!-- <a href="javascript:startLookup(doSearch);" tabindex="6">search</a> -->
            </div>
            <div id="dataContainer" class="fadable"></div>
        </div>
        <div id="ruler" class="inputText">word</div> <!-- Placeholder text goes here -->

        <!-- Utility functions -->
        <script type="text/javascript">
            function id(name) { return document.getElementById(name); }
            function log() {
                var s = '';
                for (var i = 0; i < arguments.length; ++i) {
                    s += arguments[i];
                    if (i != (arguments.length - 1)) s += ', ';
                }
                console.log(s);
            }
            function exists(val) { return (val == null || val == undefined || val == '') ? false : true }
            function removeAllChildren(element) { while (element.hasChildNodes()) { element.removeChild(element.firstChild);} };
            function getSelectedText() { return getSelection();}

            function getSpinner(size, numberOfBars, color) {
                var style = document.createElement('style');
                style.innerHTML = '@-webkit-keyframes fade {from {opacity: 1;} to {opacity: 0.25;}}';
                document.getElementsByTagName('head')[0].appendChild(style);
                var spinner = document.createElement('div');
                spinner.style.width = size;
                spinner.style.height = size;
                spinner.style.position = 'relative';
                var rotation = 0;
                var rotateBy = 360 / numberOfBars;
                var animationDelay = 0;
                var frameRate = 1 / numberOfBars;
                for (var i = 0; i < numberOfBars; ++i) {
                    var bar = document.createElement('div');
                    spinner.appendChild(bar);
                    bar.style.width = '12%';
                    bar.style.height = '26%';
                    bar.style.background = color;
                    bar.style.position = 'absolute';
                    bar.style.left = '44.5%';
                    bar.style.top = '37%';
                    bar.style.opacity = '0';
                    bar.style['-webkit-border-radius'] = '50px';
                    bar.style['-webkit-box-shadow'] = '0 0 3px rgba(0,0,0,0.2)';
                    bar.style['-webkit-animation'] = 'fade 1s linear infinite';
                    bar.style['-webkit-transform'] = 'rotate('+rotation+'deg) translate(0, -142%)';
                    bar.style['-webkit-animation-delay'] = animationDelay + 's';
                    rotation += rotateBy;
                    animationDelay -= frameRate;
                }
                return spinner;
            }

        </script>
    </body>
</html>